<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartX - 3D Digital Twin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://cdn.babylonjs.com/procedural-texturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        #twin-container {
            position: relative;
            height: 70vh;
            border-radius: 12px;
            overflow: hidden;
        }
        #twin-canvas {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 12px;
        }
        .control-panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .glow-effect {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-slate-900 text-white">
    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="/home" class="text-2xl font-bold text-blue-400 hover:text-blue-300 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>SmartX
                    </a>
                    <span class="ml-4 text-gray-400">|</span>
                    <h1 class="ml-4 text-xl font-semibold">Enhanced 3D Digital Twin</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse mr-2"></div>
                        <span class="text-sm text-gray-300">Live Simulation</span>
                    </div>
                    <button id="resetView" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm">
                        <i class="fas fa-refresh mr-2"></i>Reset View
                    </button>
                    <button id="toggleVR" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors text-sm">
                        <i class="fas fa-vr-cardboard mr-2"></i>VR Mode
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- 3D Viewer -->
            <div class="lg:col-span-3">
                <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden glow-effect">
                    <div class="p-4 border-b border-slate-700">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <h2 class="text-lg font-semibold">Enhanced Machine Visualization</h2>

                            <!-- Machine Selection -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">Machine:</span>
                                <select id="machineSelect" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm border border-slate-600">
                                    <option value="cnc">CNC Machine</option>
                                    <option value="robot" selected>Robotic Arm</option>
                                    <option value="conveyor">Conveyor System</option>
                                    <option value="assembly">Assembly Station</option>
                                    <option value="press">Hydraulic Press</option>
                                    <option value="turbine">Wind Turbine</option>
                                    <option value="reactor">Chemical Reactor</option>
                                </select>
                            </div>

                            <!-- View Controls -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">View:</span>
                                <button id="frontView" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm">Front</button>
                                <button id="topView" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm">Top</button>
                                <button id="sideView" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm">Side</button>
                                <button id="isoView" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm">Iso</button>
                            </div>

                            <!-- Rendering Options -->
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-400">Wireframe:</label>
                                    <input type="checkbox" id="wireframeToggle" class="form-checkbox text-blue-400">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-400">Animation:</label>
                                    <input type="checkbox" id="animationToggle" checked class="form-checkbox text-blue-400">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-400">Particles:</label>
                                    <input type="checkbox" id="particlesToggle" checked class="form-checkbox text-blue-400">
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Controls Row -->
                        <div class="flex items-center justify-between mt-3 flex-wrap gap-4">
                            <!-- Material Selection -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">Material:</span>
                                <select id="materialSelect" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm border border-slate-600">
                                    <option value="standard">Standard</option>
                                    <option value="metallic">Metallic</option>
                                    <option value="carbon">Carbon Fiber</option>
                                    <option value="glass">Glass</option>
                                    <option value="ceramic">Ceramic</option>
                                </select>
                            </div>

                            <!-- Post-Processing -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">Effects:</span>
                                <select id="postProcessSelect" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm border border-slate-600">
                                    <option value="none">None</option>
                                    <option value="bloom">Bloom</option>
                                    <option value="ssao">SSAO</option>
                                    <option value="outline">Outline</option>
                                    <option value="all">All Effects</option>
                                </select>
                            </div>

                            <!-- Quality Settings -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">Quality:</span>
                                <select id="qualitySelect" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm border border-slate-600">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="ultra">Ultra</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="twin-container">
                        <canvas id="twin-canvas"></canvas>

                        <!-- 3D UI Overlay -->
                        <div class="absolute top-4 right-4 control-panel rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-2">3D Controls</div>
                            <div class="text-xs text-gray-300 space-y-1">
                                <div><i class="fas fa-mouse mr-2"></i>Left: Rotate</div>
                                <div><i class="fas fa-mouse mr-2"></i>Right: Pan</div>
                                <div><i class="fas fa-scroll mr-2"></i>Wheel: Zoom</div>
                                <div><i class="fas fa-keyboard mr-2"></i>WASD: Move</div>
                            </div>
                        </div>

                        <!-- Performance Monitor -->
                        <div class="absolute bottom-4 left-4 control-panel rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Performance</div>
                            <div class="text-xs text-gray-300">
                                <div>FPS: <span id="fpsDisplay">--</span></div>
                                <div>Draw Calls: <span id="drawCallsDisplay">--</span></div>
                                <div>Triangles: <span id="trianglesDisplay">--</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Control Panel -->
            <div class="space-y-6">
                <!-- Real-time Metrics -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4">Live Sensor Data</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-red-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-gray-400 text-sm">Temperature</span>
                            </div>
                            <div class="text-right">
                                <div id="twinTemp" class="text-white font-semibold">--째F</div>
                                <div class="w-20 bg-slate-700 rounded-full h-2 mt-1">
                                    <div id="tempBar" class="bg-red-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-blue-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-gray-400 text-sm">Pressure</span>
                            </div>
                            <div class="text-right">
                                <div id="twinPressure" class="text-white font-semibold">-- bar</div>
                                <div class="w-20 bg-slate-700 rounded-full h-2 mt-1">
                                    <div id="pressureBar" class="bg-blue-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-yellow-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-gray-400 text-sm">Vibration</span>
                            </div>
                            <div class="text-right">
                                <div id="twinVibration" class="text-white font-semibold">--</div>
                                <div class="w-20 bg-slate-700 rounded-full h-2 mt-1">
                                    <div id="vibrationBar" class="bg-yellow-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-gray-400 text-sm">RPM</span>
                            </div>
                            <div class="text-right">
                                <div id="twinRpm" class="text-white font-semibold">-- rpm</div>
                                <div class="w-20 bg-slate-700 rounded-full h-2 mt-1">
                                    <div id="rpmBar" class="bg-green-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-purple-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-gray-400 text-sm">Power</span>
                            </div>
                            <div class="text-right">
                                <div id="twinPower" class="text-white font-semibold">-- kW</div>
                                <div class="w-20 bg-slate-700 rounded-full h-2 mt-1">
                                    <div id="powerBar" class="bg-purple-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Graphics Settings -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4">Graphics Settings</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Lighting Intensity</span>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="lightingControl" min="0" max="100" value="80" class="slider w-20">
                                <span id="lightingValue" class="text-white text-sm w-8">80%</span>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Shadow Quality</span>
                            <select id="shadowQuality" class="px-2 py-1 bg-slate-700 rounded text-sm border border-slate-600">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="ultra">Ultra</option>
                            </select>
                        </div>

                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Reflection Quality</span>
                            <input type="range" id="reflectionQuality" min="0" max="100" value="70" class="slider w-20">
                        </div>

                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Anti-Aliasing</span>
                            <input type="checkbox" id="antiAliasing" checked class="form-checkbox text-blue-400">
                        </div>

                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">HDR</span>
                            <input type="checkbox" id="hdrToggle" checked class="form-checkbox text-blue-400">
                        </div>

                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Ambient Occlusion</span>
                            <input type="checkbox" id="aoToggle" class="form-checkbox text-blue-400">
                        </div>
                    </div>
                </div>

                <!-- Camera Controls -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4">Camera Controls</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">FOV</span>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="fovControl" min="30" max="120" value="75" class="slider w-20">
                                <span id="fovValue" class="text-white text-sm w-8">75째</span>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Speed</span>
                            <input type="range" id="cameraSpeed" min="1" max="10" value="5" class="slider w-20">
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <button id="orbitMode" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                                <i class="fas fa-sync mr-1"></i>Orbit
                            </button>
                            <button id="flyMode" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                <i class="fas fa-paper-plane mr-1"></i>Fly
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4">System Status</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Operational State</span>
                            <span id="twinStatus" class="px-2 py-1 rounded-full text-xs font-semibold bg-green-500/20 text-green-400">
                                <i class="fas fa-circle mr-1"></i>Operating
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Efficiency</span>
                            <span id="twinEfficiency" class="text-white font-semibold">92%</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Uptime</span>
                            <span id="uptime" class="text-white font-semibold">24h 15m</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4">Actions</h3>
                    <div class="space-y-2">
                        <div class="flex space-x-2">
                            <a href="/home" class="text-gray-300 hover:text-white transition">
                                <i class="fas fa-arrow-left mr-1"></i>Back to Features
                            </a>
                        </div>
                        <button onclick="window.location.href='/dashboard'" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-sm flex items-center justify-center">
                            <i class="fas fa-chart-line mr-2"></i>View Dashboard
                        </button>
                        <button onclick="window.location.href='/predict'" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors text-sm flex items-center justify-center">
                            <i class="fas fa-brain mr-2"></i>Run Prediction
                        </button>
                        <button id="captureScreenshot" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors text-sm flex items-center justify-center">
                            <i class="fas fa-camera mr-2"></i>Screenshot
                        </button>
                        <button id="recordVideo" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors text-sm flex items-center justify-center">
                            <i class="fas fa-video mr-2"></i>Record
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let engine, scene, camera, sensorData = {};
        let machineGroup, currentMachine = 'robot';
        let animationRunning = true;
        let rotatingParts = [];
        let vrHelper = null;

        // Initialize Babylon.js scene
        function initBabylonScene() {
            const canvas = document.getElementById('twin-canvas');
            engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });

            scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3(0.05, 0.09, 0.16);

            // Enhanced camera
            camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 3, 10, BABYLON.Vector3.Zero(), scene);
            camera.setTarget(BABYLON.Vector3.Zero());

            // Attach controls properly
            camera.attachControls(canvas, true);

            // Enhanced lighting
            setupEnhancedLighting();

            // Create machine
            createEnhancedMachine();

            // Start render loop
            engine.runRenderLoop(() => {
                updatePerformanceDisplay();
                if (animationRunning) {
                    animateMachine();
                }
                scene.render();
            });

            // Handle resize
            window.addEventListener("resize", () => {
                engine.resize();
            });

            // Setup VR
            setupVR();
        }

        function setupVR() {
            // Initialize VR helper
            if (BABYLON.WebXRSessionManager.IsSessionSupportedAsync) {
                scene.createDefaultXRExperienceAsync().then((xrExperience) => {
                    vrHelper = xrExperience;
                    console.log("VR initialized successfully");
                }).catch((error) => {
                    console.log("VR not supported:", error);
                    // Fallback to basic VR using device orientation
                    setupBasicVR();
                });
            } else {
                setupBasicVR();
            }
        }

        function setupBasicVR() {
            // Basic VR fallback using device orientation
            if (BABYLON.DeviceOrientationCamera) {
                const vrCamera = new BABYLON.DeviceOrientationCamera("vrCamera", new BABYLON.Vector3(0, 5, -10), scene);
                vrCamera.setTarget(BABYLON.Vector3.Zero());
            }
        }

        function setupEnhancedLighting() {
            // Ambient light
            const ambientLight = new BABYLON.HemisphericLight("ambientLight", new BABYLON.Vector3(0, 1, 0), scene);
            ambientLight.intensity = 0.4;

            // Main directional light
            const directionalLight = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(-1, -1, -1), scene);
            directionalLight.intensity = 1.2;

            // Point lights for atmosphere
            const pointLight1 = new BABYLON.PointLight("pointLight1", new BABYLON.Vector3(10, 10, 0), scene);
            pointLight1.diffuse = new BABYLON.Color3(0.2, 0.4, 1);
            pointLight1.intensity = 0.6;

            const pointLight2 = new BABYLON.PointLight("pointLight2", new BABYLON.Vector3(-10, 5, 10), scene);
            pointLight2.diffuse = new BABYLON.Color3(1, 0.4, 0.2);
            pointLight2.intensity = 0.4;
        }

        function createEnhancedMachine() {
            machineGroup = new BABYLON.TransformNode("machineGroup", scene);
            rotatingParts = [];

            // Create different machine types
            switch(currentMachine) {
                case 'robot':
                    createRoboticArm();
                    break;
                case 'cnc':
                    createCNCMachine();
                    break;
                case 'turbine':
                    createWindTurbine();
                    break;
                case 'conveyor':
                    createConveyorSystem();
                    break;
                case 'assembly':
                    createAssemblyStation();
                    break;
                case 'press':
                    createHydraulicPress();
                    break;
                case 'reactor':
                    createChemicalReactor();
                    break;
                default:
                    createRoboticArm();
            }

            // Add ground
            createEnhancedGround();
        }

        function createRoboticArm() {
            // Base
            const base = BABYLON.MeshBuilder.CreateCylinder("base", {height: 1, diameter: 2}, scene);
            base.position.y = 0.5;
            base.parent = machineGroup;

            // Enhanced material
            const baseMaterial = new BABYLON.StandardMaterial("baseMaterial", scene);
            baseMaterial.diffuseColor = new BABYLON.Color3(0.2, 0.3, 0.8);
            baseMaterial.specularColor = new BABYLON.Color3(0.5, 0.5, 0.5);
            base.material = baseMaterial;

            // Rotating base
            const rotatingBase = BABYLON.MeshBuilder.CreateCylinder("rotatingBase", {height: 0.2, diameter: 1.8}, scene);
            rotatingBase.position.y = 1.1;
            rotatingBase.parent = machineGroup;
            rotatingBase.material = baseMaterial;
            rotatingParts.push({mesh: rotatingBase, axis: 'y', speed: 0.02});

            // Arm segments with joints
            for (let i = 0; i < 3; i++) {
                const segment = BABYLON.MeshBuilder.CreateBox("segment" + i, {width: 0.3, height: 1.5, depth: 0.3}, scene);
                segment.position.y = 1.5 + (i * 1.2);
                segment.rotation.z = Math.sin(Date.now() * 0.001 + i) * 0.3;
                segment.parent = machineGroup;

                const segmentMaterial = new BABYLON.StandardMaterial("segmentMaterial" + i, scene);
                segmentMaterial.diffuseColor = new BABYLON.Color3(0.6, 0.6, 0.6);
                segmentMaterial.specularColor = new BABYLON.Color3(0.8, 0.8, 0.8);
                segment.material = segmentMaterial;

                rotatingParts.push({mesh: segment, axis: 'z', speed: 0.01 + i * 0.005});

                // Joint
                const joint = BABYLON.MeshBuilder.CreateSphere("joint" + i, {diameter: 0.4}, scene);
                joint.position.y = segment.position.y - 0.6;
                joint.parent = machineGroup;
                joint.material = baseMaterial;
            }

            // End effector
            const endEffector = BABYLON.MeshBuilder.CreateBox("endEffector", {width: 0.5, height: 0.2, depth: 0.2}, scene);
            endEffector.position.y = 5;
            endEffector.parent = machineGroup;
            endEffector.material = baseMaterial;
            rotatingParts.push({mesh: endEffector, axis: 'x', speed: 0.03});
        }

        function createWindTurbine() {
            // Tower
            const tower = BABYLON.MeshBuilder.CreateCylinder("tower", {height: 8, diameterTop: 0.8, diameterBottom: 1.2}, scene);
            tower.position.y = 4;
            tower.parent = machineGroup;

            const towerMaterial = new BABYLON.StandardMaterial("towerMaterial", scene);
            towerMaterial.diffuseColor = new BABYLON.Color3(0.9, 0.9, 0.9);
            tower.material = towerMaterial;

            // Nacelle
            const nacelle = BABYLON.MeshBuilder.CreateBox("nacelle", {width: 3, height: 1, depth: 1}, scene);
            nacelle.position.y = 8;
            nacelle.parent = machineGroup;
            nacelle.material = towerMaterial;

            // Hub
            const hub = BABYLON.MeshBuilder.CreateSphere("hub", {diameter: 0.8}, scene);
            hub.position = new BABYLON.Vector3(1.5, 8, 0);
            hub.parent = machineGroup;
            rotatingParts.push({mesh: hub, axis: 'x', speed: 0.1});

            // Blades
            for (let i = 0; i < 3; i++) {
                const blade = BABYLON.MeshBuilder.CreateBox("blade" + i, {width: 0.1, height: 4, depth: 0.5}, scene);
                blade.position = new BABYLON.Vector3(1.5, 10, 0);
                blade.rotation.x = (i * Math.PI * 2 / 3);
                blade.parent = hub;

                const bladeMaterial = new BABYLON.StandardMaterial("bladeMaterial", scene);
                bladeMaterial.diffuseColor = new BABYLON.Color3(0.8, 0.8, 0.9);
                blade.material = bladeMaterial;
            }
        }

        function createCNCMachine() {
            // CNC Base
            const base = BABYLON.MeshBuilder.CreateBox("cncBase", {width: 3, height: 0.5, depth: 2}, scene);
            base.position.y = 0.25;
            base.parent = machineGroup;

            const baseMaterial = new BABYLON.StandardMaterial("cncBaseMaterial", scene);
            baseMaterial.diffuseColor = new BABYLON.Color3(0.2, 0.3, 0.8);
            base.material = baseMaterial;

            // Spindle housing
            const housing = BABYLON.MeshBuilder.CreateBox("housing", {width: 0.8, height: 1.5, depth: 0.8}, scene);
            housing.position.set(0, 1.25, 0);
            housing.parent = machineGroup;
            housing.material = baseMaterial;

            // Rotating spindle
            const spindle = BABYLON.MeshBuilder.CreateCylinder("spindle", {height: 1, diameter: 0.1}, scene);
            spindle.position.set(0, 0.75, 0);
            spindle.parent = machineGroup;

            const spindleMaterial = new BABYLON.StandardMaterial("spindleMaterial", scene);
            spindleMaterial.diffuseColor = new BABYLON.Color3(1, 0.3, 0.3);
            spindle.material = spindleMaterial;
            rotatingParts.push({mesh: spindle, axis: 'y', speed: 0.3});

            // Work table
            const table = BABYLON.MeshBuilder.CreateBox("table", {width: 2, height: 0.2, depth: 1.5}, scene);
            table.position.y = 0.6;
            table.parent = machineGroup;

            const tableMaterial = new BABYLON.StandardMaterial("tableMaterial", scene);
            tableMaterial.diffuseColor = new BABYLON.Color3(0.5, 0.5, 0.6);
            table.material = tableMaterial;
        }

        function createConveyorSystem() {
            // Belt
            const belt = BABYLON.MeshBuilder.CreateBox("belt", {width: 6, height: 0.2, depth: 1}, scene);
            belt.position.y = 0.6;
            belt.parent = machineGroup;

            const beltMaterial = new BABYLON.StandardMaterial("beltMaterial", scene);
            beltMaterial.diffuseColor = new BABYLON.Color3(0.3, 0.3, 0.3);
            belt.material = beltMaterial;

            // Rollers
            for (let i = 0; i < 7; i++) {
                const roller = BABYLON.MeshBuilder.CreateCylinder("roller" + i, {height: 1.2, diameter: 0.2}, scene);
                roller.position.set(-2.5 + i * 0.8, 0.5, 0);
                roller.rotation.z = Math.PI / 2;
                roller.parent = machineGroup;

                const rollerMaterial = new BABYLON.StandardMaterial("rollerMaterial", scene);
                rollerMaterial.diffuseColor = new BABYLON.Color3(0.6, 0.6, 0.7);
                roller.material = rollerMaterial;
                rotatingParts.push({mesh: roller, axis: 'z', speed: 0.05});
            }

            // Moving packages
            for (let i = 0; i < 3; i++) {
                const package = BABYLON.MeshBuilder.CreateBox("package" + i, {width: 0.3, height: 0.3, depth: 0.3}, scene);
                package.position.set(-2 + i * 1.5, 0.85, 0);
                package.parent = machineGroup;

                const packageMaterial = new BABYLON.StandardMaterial("packageMaterial", scene);
                packageMaterial.diffuseColor = new BABYLON.Color3(0.8, 0.5, 0.2);
                package.material = packageMaterial;
                rotatingParts.push({mesh: package, axis: 'move', speed: 0.02, moveDirection: new BABYLON.Vector3(1, 0, 0)});
            }
        }

        function createAssemblyStation() {
            // Platform
            const platform = BABYLON.MeshBuilder.CreateBox("platform", {width: 2.5, height: 0.3, depth: 2.5}, scene);
            platform.position.y = 0.15;
            platform.parent = machineGroup;

            const platformMaterial = new BABYLON.StandardMaterial("platformMaterial", scene);
            platformMaterial.diffuseColor = new BABYLON.Color3(0.2, 0.3, 0.8);
            platform.material = platformMaterial;

            // Assembly arms
            for (let i = 0; i < 4; i++) {
                const angle = (i / 4) * Math.PI * 2;
                const armBase = BABYLON.MeshBuilder.CreateCylinder("armBase" + i, {height: 0.5, diameter: 0.2}, scene);
                armBase.position.set(Math.cos(angle) * 0.8, 0.55, Math.sin(angle) * 0.8);
                armBase.parent = machineGroup;

                const arm = BABYLON.MeshBuilder.CreateBox("arm" + i, {width: 0.8, height: 0.1, depth: 0.1}, scene);
                arm.position.set(Math.cos(angle) * 1.2, 0.8, Math.sin(angle) * 1.2);
                arm.parent = machineGroup;

                const armMaterial = new BABYLON.StandardMaterial("armMaterial", scene);
                armMaterial.diffuseColor = new BABYLON.Color3(0.6, 0.3, 0.8);
                arm.material = armMaterial;
                armBase.material = armMaterial;

                rotatingParts.push({mesh: arm, axis: 'y', speed: 0.02 + i * 0.01});
            }

            // Central assembly point
            const center = BABYLON.MeshBuilder.CreateCylinder("center", {height: 0.3, diameter: 0.4}, scene);
            center.position.y = 0.45;
            center.parent = machineGroup;

            const centerMaterial = new BABYLON.StandardMaterial("centerMaterial", scene);
            centerMaterial.diffuseColor = new BABYLON.Color3(1, 0.3, 0.3);
            center.material = centerMaterial;
            rotatingParts.push({mesh: center, axis: 'y', speed: 0.08});
        }

        function createHydraulicPress() {
            // Frame
            const frame = BABYLON.MeshBuilder.CreateBox("frame", {width: 2, height: 3, depth: 1.5}, scene);
            frame.position.y = 1.5;
            frame.parent = machineGroup;

            const frameMaterial = new BABYLON.StandardMaterial("frameMaterial", scene);
            frameMaterial.diffuseColor = new BABYLON.Color3(0.1, 0.2, 0.3);
            frame.material = frameMaterial;

            // Hydraulic cylinder
            const cylinder = BABYLON.MeshBuilder.CreateCylinder("cylinder", {height: 1.5, diameter: 0.4}, scene);
            cylinder.position.set(0, 2.5, 0);
            cylinder.parent = machineGroup;

            const cylinderMaterial = new BABYLON.StandardMaterial("cylinderMaterial", scene);
            cylinderMaterial.diffuseColor = new BABYLON.Color3(0.6, 0.6, 0.7);
            cylinder.material = cylinderMaterial;

            // Press head (moving part)
            const head = BABYLON.MeshBuilder.CreateBox("head", {width: 1.5, height: 0.3, depth: 1.2}, scene);
            head.position.set(0, 1.8, 0);
            head.parent = machineGroup;

            const headMaterial = new BABYLON.StandardMaterial("headMaterial", scene);
            headMaterial.diffuseColor = new BABYLON.Color3(1, 0.3, 0.3);
            head.material = headMaterial;
            rotatingParts.push({mesh: head, axis: 'move', speed: 0.01, moveDirection: new BABYLON.Vector3(0, 1, 0), oscillate: true});

            // Base plate
            const baseplate = BABYLON.MeshBuilder.CreateBox("baseplate", {width: 1.8, height: 0.2, depth: 1.4}, scene);
            baseplate.position.y = 0.6;
            baseplate.parent = machineGroup;

            const baseMaterial = new BABYLON.StandardMaterial("baseMaterial", scene);
            baseMaterial.diffuseColor = new BABYLON.Color3(0.4, 0.4, 0.5);
            baseplate.material = baseMaterial;
        }

        function createChemicalReactor() {
            // Main reactor vessel
            const vessel = BABYLON.MeshBuilder.CreateCylinder("vessel", {height: 4, diameter: 2.5}, scene);
            vessel.position.y = 2;
            vessel.parent = machineGroup;

            const vesselMaterial = new BABYLON.StandardMaterial("vesselMaterial", scene);
            vesselMaterial.diffuseColor = new BABYLON.Color3(0.8, 0.8, 0.9);
            vessel.material = vesselMaterial;

            // Stirrer
            const stirrer = BABYLON.MeshBuilder.CreateCylinder("stirrer", {height: 3.5, diameter: 0.1}, scene);
            stirrer.position.y = 2;
            stirrer.parent = machineGroup;

            const stirrerMaterial = new BABYLON.StandardMaterial("stirrerMaterial", scene);
            stirrerMaterial.diffuseColor = new BABYLON.Color3(0.3, 0.3, 0.3);
            stirrer.material = stirrerMaterial;
            rotatingParts.push({mesh: stirrer, axis: 'y', speed: 0.15});

            // Stirrer blades
            for (let i = 0; i < 4; i++) {
                const blade = BABYLON.MeshBuilder.CreateBox("stirrerBlade" + i, {width: 0.8, height: 0.1, depth: 0.05}, scene);
                blade.position.set(0, 0.5 + i * 0.8, 0);
                blade.rotation.y = (i * Math.PI / 2);
                blade.parent = stirrer;

                const bladeMaterial = new BABYLON.StandardMaterial("bladeMaterial", scene);
                bladeMaterial.diffuseColor = new BABYLON.Color3(0.5, 0.5, 0.5);
                blade.material = bladeMaterial;
            }

            // Pipes
            for (let i = 0; i < 3; i++) {
                const pipe = BABYLON.MeshBuilder.CreateCylinder("pipe" + i, {height: 1, diameter: 0.2}, scene);
                const angle = (i / 3) * Math.PI * 2;
                pipe.position.set(Math.cos(angle) * 1.5, 3 + i * 0.3, Math.sin(angle) * 1.5);
                pipe.rotation.z = Math.PI / 2;
                pipe.parent = machineGroup;

                const pipeMaterial = new BABYLON.StandardMaterial("pipeMaterial", scene);
                pipeMaterial.diffuseColor = new BABYLON.Color3(0.3, 0.6, 0.3);
                pipe.material = pipeMaterial;
            }
        }

        function createEnhancedGround() {
            const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 20, height: 20}, scene);

            const groundMaterial = new BABYLON.StandardMaterial("groundMaterial", scene);
            groundMaterial.diffuseColor = new BABYLON.Color3(0.1, 0.15, 0.2);
            ground.material = groundMaterial;
        }

        function animateMachine() {
            if (rotatingParts.length > 0) {
                const time = performance.now() * 0.001;

                rotatingParts.forEach(part => {
                    if (part.axis === 'x') {
                        part.mesh.rotation.x += part.speed;
                    } else if (part.axis === 'y') {
                        part.mesh.rotation.y += part.speed;
                    } else if (part.axis === 'z') {
                        part.mesh.rotation.z += part.speed;
                    } else if (part.axis === 'move') {
                        if (part.oscillate) {
                            const oscillation = Math.sin(time * part.speed * 10) * 0.3;
                            part.mesh.position.y = part.mesh.position.y + oscillation * 0.01;
                        } else {
                            part.mesh.position.x += part.speed;
                            if (part.mesh.position.x > 3) {
                                part.mesh.position.x = -3;
                            }
                        }
                    }
                });
            }

            // Update sensor-based effects
            updateSensorEffects();
        }

        function updateSensorEffects() {
            if (sensorData.vibration > 0.8 && machineGroup) {
                // Add vibration effect
                const vibrationOffset = (Math.random() - 0.5) * 0.05;
                machineGroup.position.x = vibrationOffset;
                machineGroup.position.z = vibrationOffset;
            }
        }

        function updatePerformanceDisplay() {
            document.getElementById('fpsDisplay').textContent = Math.round(engine.getFps());
            document.getElementById('drawCallsDisplay').textContent = scene.getActiveMeshes().length;
            document.getElementById('trianglesDisplay').textContent = scene.getTotalVertices();
        }

        // Event listeners and API calls
        document.addEventListener('DOMContentLoaded', function() {
            initBabylonScene();
            setupEventListeners();
            startDataUpdates();
        });

        function setupEventListeners() {
            // Machine selection
            document.getElementById('machineSelect').addEventListener('change', function(e) {
                currentMachine = e.target.value;
                switchMachine(currentMachine);
            });

            // VR toggle
            document.getElementById('toggleVR').addEventListener('click', function() {
                if (vrHelper && vrHelper.baseExperience) {
                    vrHelper.baseExperience.enterXRAsync("immersive-vr", "local-floor").then(() => {
                        console.log("Entered VR mode");
                    }).catch((error) => {
                        console.log("VR entry failed:", error);
                        // Fallback VR simulation
                        simulateVRMode();
                    });
                } else {
                    simulateVRMode();
                }
            });

            // Graphics controls
            document.getElementById('lightingControl').addEventListener('input', function(e) {
                const intensity = e.target.value / 100;
                scene.lights.forEach(light => {
                    if (light instanceof BABYLON.DirectionalLight) {
                        light.intensity = intensity * 1.2;
                    }
                });
                document.getElementById('lightingValue').textContent = e.target.value + '%';
            });

            document.getElementById('fovControl').addEventListener('input', function(e) {
                camera.fov = (e.target.value * Math.PI) / 180;
                document.getElementById('fovValue').textContent = e.target.value + '째';
            });

            // Animation toggle
            document.getElementById('animationToggle').addEventListener('change', function(e) {
                animationRunning = e.target.checked;
            });

            // Screenshot
            document.getElementById('captureScreenshot').addEventListener('click', function() {
                BABYLON.ScreenshotTools.CreateScreenshotUsingRenderTarget(engine, camera, 1920);
            });

            // Reset view
            document.getElementById('resetView').addEventListener('click', resetView);

            // View buttons
            document.getElementById('frontView').addEventListener('click', () => setView('front'));
            document.getElementById('topView').addEventListener('click', () => setView('top'));
            document.getElementById('sideView').addEventListener('click', () => setView('side'));
            document.getElementById('isoView').addEventListener('click', () => setView('iso'));
        }

        function simulateVRMode() {
            // Simulate VR by changing camera position and FOV
            camera.fov = Math.PI / 2; // Wider FOV for VR feel
            camera.position = new BABYLON.Vector3(0, 2, -5);
            camera.setTarget(new BABYLON.Vector3(0, 1, 0));
            alert("VR Mode Simulated! Use mouse to look around.");
        }

        function switchMachine(machineType) {
            if (machineGroup) {
                machineGroup.dispose();
            }
            currentMachine = machineType;
            createEnhancedMachine();
        }

        function setView(viewType) {
            switch (viewType) {
                case 'front':
                    camera.position = new BABYLON.Vector3(0, 2, 8);
                    camera.setTarget(new BABYLON.Vector3(0, 1, 0));
                    break;
                case 'top':
                    camera.position = new BABYLON.Vector3(0, 10, 0);
                    camera.setTarget(new BABYLON.Vector3(0, 0, 0));
                    break;
                case 'side':
                    camera.position = new BABYLON.Vector3(8, 2, 0);
                    camera.setTarget(new BABYLON.Vector3(0, 1, 0));
                    break;
                case 'iso':
                    camera.position = new BABYLON.Vector3(5, 5, 5);
                    camera.setTarget(new BABYLON.Vector3(0, 1, 0));
                    break;
            }
        }

        function resetView() {
            camera.position = new BABYLON.Vector3(5, 5, 5);
            camera.setTarget(new BABYLON.Vector3(0, 1, 0));
            camera.fov = Math.PI / 4;
        }

        // Data updates
        function startDataUpdates() {
            updateSensorData();
            setInterval(updateSensorData, 3000);
        }

        async function updateSensorData() {
            try {
                const response = await fetch('/api/twin-data');
                const data = await response.json();
                sensorData = data;

                updateSensorDisplay(data);
                updateSensorVisualization(data);

            } catch (error) {
                console.error('Error updating twin data:', error);
            }
        }

        function updateSensorDisplay(data) {
            document.getElementById('twinTemp').textContent = `${data.temperature}째F`;
            document.getElementById('twinPressure').textContent = `${data.pressure} bar`;
            document.getElementById('twinVibration').textContent = `${data.vibration}`;
            document.getElementById('twinRpm').textContent = `${data.rpm} rpm`;
            document.getElementById('twinPower').textContent = `${data.power} kW`;

            // Update progress bars
            document.getElementById('tempBar').style.width = `${Math.min(100, (data.temperature / 100) * 100)}%`;
            document.getElementById('pressureBar').style.width = `${Math.min(100, (data.pressure / 3) * 100)}%`;
            document.getElementById('vibrationBar').style.width = `${Math.min(100, (data.vibration / 1.5) * 100)}%`;
            document.getElementById('rpmBar').style.width = `${Math.min(100, (data.rpm / 3000) * 100)}%`;
            document.getElementById('powerBar').style.width = `${Math.min(100, (data.power / 200) * 100)}%`;

            // Update status
            const statusElement = document.getElementById('twinStatus');
            statusElement.textContent = data.status;
            statusElement.className = `px-2 py-1 rounded-full text-xs font-semibold bg-${data.status.toLowerCase() === 'operating' ? 'green' : data.status.toLowerCase() === 'warning' ? 'yellow' : 'red'}-500/20 text-${data.status.toLowerCase() === 'operating' ? 'green' : data.status.toLowerCase() === 'warning' ? 'yellow' : 'red'}-400`;
        }

        function updateSensorVisualization(data) {
            updateSensorEffects();
        }
    </script>
</body>
</html>