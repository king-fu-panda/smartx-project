
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartX - 3D Digital Twin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://cdn.babylonjs.com/procedural-texturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        #twin-container {
            position: relative;
            height: 70vh;
            border-radius: 12px;
            overflow: hidden;
        }
        #twin-canvas {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 12px;
        }
        .control-panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .glow-effect {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-slate-900 text-white">
    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-blue-400 hover:text-blue-300 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>SmartX
                    </a>
                    <span class="ml-4 text-gray-400">|</span>
                    <h1 class="ml-4 text-xl font-semibold">Enhanced 3D Digital Twin</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse mr-2"></div>
                        <span class="text-sm text-gray-300">Live Simulation</span>
                    </div>
                    <button id="resetView" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm">
                        <i class="fas fa-refresh mr-2"></i>Reset View
                    </button>
                    <button id="toggleVR" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors text-sm">
                        <i class="fas fa-vr-cardboard mr-2"></i>VR Mode
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- 3D Viewer -->
            <div class="lg:col-span-3">
                <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden glow-effect">
                    <div class="p-4 border-b border-slate-700">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <h2 class="text-lg font-semibold">Enhanced Machine Visualization</h2>
                            
                            <!-- Machine Selection -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">Machine:</span>
                                <select id="machineSelect" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm border border-slate-600">
                                    <option value="cnc">CNC Machine</option>
                                    <option value="robot" selected>Robotic Arm</option>
                                    <option value="conveyor">Conveyor System</option>
                                    <option value="assembly">Assembly Station</option>
                                    <option value="press">Hydraulic Press</option>
                                    <option value="turbine">Wind Turbine</option>
                                    <option value="reactor">Chemical Reactor</option>
                                </select>
                            </div>
                            
                            <!-- View Controls -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">View:</span>
                                <button id="frontView" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm">Front</button>
                                <button id="topView" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm">Top</button>
                                <button id="sideView" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm">Side</button>
                                <button id="isoView" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm">Iso</button>
                            </div>
                            
                            <!-- Rendering Options -->
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-400">Wireframe:</label>
                                    <input type="checkbox" id="wireframeToggle" class="form-checkbox text-blue-400">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-400">Animation:</label>
                                    <input type="checkbox" id="animationToggle" checked class="form-checkbox text-blue-400">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-400">Particles:</label>
                                    <input type="checkbox" id="particlesToggle" checked class="form-checkbox text-blue-400">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Controls Row -->
                        <div class="flex items-center justify-between mt-3 flex-wrap gap-4">
                            <!-- Material Selection -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">Material:</span>
                                <select id="materialSelect" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm border border-slate-600">
                                    <option value="standard">Standard</option>
                                    <option value="metallic">Metallic</option>
                                    <option value="carbon">Carbon Fiber</option>
                                    <option value="glass">Glass</option>
                                    <option value="ceramic">Ceramic</option>
                                </select>
                            </div>
                            
                            <!-- Post-Processing -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">Effects:</span>
                                <select id="postProcessSelect" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm border border-slate-600">
                                    <option value="none">None</option>
                                    <option value="bloom">Bloom</option>
                                    <option value="ssao">SSAO</option>
                                    <option value="outline">Outline</option>
                                    <option value="all">All Effects</option>
                                </select>
                            </div>
                            
                            <!-- Quality Settings -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">Quality:</span>
                                <select id="qualitySelect" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm border border-slate-600">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="ultra">Ultra</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="twin-container">
                        <canvas id="twin-canvas"></canvas>
                        
                        <!-- 3D UI Overlay -->
                        <div class="absolute top-4 right-4 control-panel rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-2">3D Controls</div>
                            <div class="text-xs text-gray-300 space-y-1">
                                <div><i class="fas fa-mouse mr-2"></i>Left: Rotate</div>
                                <div><i class="fas fa-mouse mr-2"></i>Right: Pan</div>
                                <div><i class="fas fa-scroll mr-2"></i>Wheel: Zoom</div>
                                <div><i class="fas fa-keyboard mr-2"></i>WASD: Move</div>
                            </div>
                        </div>
                        
                        <!-- Performance Monitor -->
                        <div class="absolute bottom-4 left-4 control-panel rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Performance</div>
                            <div class="text-xs text-gray-300">
                                <div>FPS: <span id="fpsDisplay">--</span></div>
                                <div>Draw Calls: <span id="drawCallsDisplay">--</span></div>
                                <div>Triangles: <span id="trianglesDisplay">--</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Control Panel -->
            <div class="space-y-6">
                <!-- Real-time Metrics -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4">Live Sensor Data</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-red-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-gray-400 text-sm">Temperature</span>
                            </div>
                            <div class="text-right">
                                <div id="twinTemp" class="text-white font-semibold">--째F</div>
                                <div class="w-20 bg-slate-700 rounded-full h-2 mt-1">
                                    <div id="tempBar" class="bg-red-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-blue-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-gray-400 text-sm">Pressure</span>
                            </div>
                            <div class="text-right">
                                <div id="twinPressure" class="text-white font-semibold">-- bar</div>
                                <div class="w-20 bg-slate-700 rounded-full h-2 mt-1">
                                    <div id="pressureBar" class="bg-blue-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-yellow-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-gray-400 text-sm">Vibration</span>
                            </div>
                            <div class="text-right">
                                <div id="twinVibration" class="text-white font-semibold">--</div>
                                <div class="w-20 bg-slate-700 rounded-full h-2 mt-1">
                                    <div id="vibrationBar" class="bg-yellow-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-gray-400 text-sm">RPM</span>
                            </div>
                            <div class="text-right">
                                <div id="twinRpm" class="text-white font-semibold">-- rpm</div>
                                <div class="w-20 bg-slate-700 rounded-full h-2 mt-1">
                                    <div id="rpmBar" class="bg-green-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-purple-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-gray-400 text-sm">Power</span>
                            </div>
                            <div class="text-right">
                                <div id="twinPower" class="text-white font-semibold">-- kW</div>
                                <div class="w-20 bg-slate-700 rounded-full h-2 mt-1">
                                    <div id="powerBar" class="bg-purple-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Graphics Settings -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4">Graphics Settings</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Lighting Intensity</span>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="lightingControl" min="0" max="100" value="80" class="slider w-20">
                                <span id="lightingValue" class="text-white text-sm w-8">80%</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Shadow Quality</span>
                            <select id="shadowQuality" class="px-2 py-1 bg-slate-700 rounded text-sm border border-slate-600">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="ultra">Ultra</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Reflection Quality</span>
                            <input type="range" id="reflectionQuality" min="0" max="100" value="70" class="slider w-20">
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Anti-Aliasing</span>
                            <input type="checkbox" id="antiAliasing" checked class="form-checkbox text-blue-400">
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">HDR</span>
                            <input type="checkbox" id="hdrToggle" checked class="form-checkbox text-blue-400">
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Ambient Occlusion</span>
                            <input type="checkbox" id="aoToggle" class="form-checkbox text-blue-400">
                        </div>
                    </div>
                </div>

                <!-- Camera Controls -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4">Camera Controls</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">FOV</span>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="fovControl" min="30" max="120" value="75" class="slider w-20">
                                <span id="fovValue" class="text-white text-sm w-8">75째</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Speed</span>
                            <input type="range" id="cameraSpeed" min="1" max="10" value="5" class="slider w-20">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button id="orbitMode" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                                <i class="fas fa-sync mr-1"></i>Orbit
                            </button>
                            <button id="flyMode" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                <i class="fas fa-paper-plane mr-1"></i>Fly
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4">System Status</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Operational State</span>
                            <span id="twinStatus" class="px-2 py-1 rounded-full text-xs font-semibold bg-green-500/20 text-green-400">
                                <i class="fas fa-circle mr-1"></i>Operating
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Efficiency</span>
                            <span id="twinEfficiency" class="text-white font-semibold">92%</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Uptime</span>
                            <span id="uptime" class="text-white font-semibold">24h 15m</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4">Actions</h3>
                    <div class="space-y-2">
                        <button onclick="window.location.href='/dashboard'" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-sm flex items-center justify-center">
                            <i class="fas fa-chart-line mr-2"></i>View Dashboard
                        </button>
                        <button onclick="window.location.href='/predict'" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors text-sm flex items-center justify-center">
                            <i class="fas fa-brain mr-2"></i>Run Prediction
                        </button>
                        <button id="captureScreenshot" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors text-sm flex items-center justify-center">
                            <i class="fas fa-camera mr-2"></i>Screenshot
                        </button>
                        <button id="recordVideo" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors text-sm flex items-center justify-center">
                            <i class="fas fa-video mr-2"></i>Record
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let engine, scene, camera, sensorData = {};
        let machineGroup, currentMachine = 'robot';
        let animationRunning = true;
        let particleSystem, postProcessPipeline;
        
        // Initialize Babylon.js scene
        function initBabylonScene() {
            const canvas = document.getElementById('twin-canvas');
            engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
            
            scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3(0.05, 0.09, 0.16);
            
            // Enhanced camera
            camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 3, 10, BABYLON.Vector3.Zero(), scene);
            camera.attachControls(canvas, true);
            camera.setTarget(BABYLON.Vector3.Zero());
            
            // Enhanced lighting
            setupEnhancedLighting();
            
            // Create machine
            createEnhancedMachine();
            
            // Setup post-processing
            setupPostProcessing();
            
            // Setup particles
            setupParticleSystem();
            
            // Start render loop
            engine.runRenderLoop(() => {
                updatePerformanceDisplay();
                if (animationRunning) {
                    animateMachine();
                }
                scene.render();
            });
            
            // Handle resize
            window.addEventListener("resize", () => {
                engine.resize();
            });
        }
        
        function setupEnhancedLighting() {
            // HDR environment
            const hdrTexture = BABYLON.CubeTexture.CreateFromPrefilteredData("/static/textures/environment.dds", scene);
            scene.environmentTexture = hdrTexture;
            scene.environmentIntensity = 0.8;
            
            // Main directional light
            const directionalLight = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(-1, -1, -1), scene);
            directionalLight.intensity = 1.2;
            directionalLight.shadowMinZ = 1;
            directionalLight.shadowMaxZ = 2500;
            
            // Shadow generator
            const shadowGenerator = new BABYLON.ShadowGenerator(2048, directionalLight);
            shadowGenerator.useBlurExponentialShadowMap = true;
            shadowGenerator.blurBoxOffset = 2.0;
            
            // Point lights for atmosphere
            const pointLight1 = new BABYLON.PointLight("pointLight1", new BABYLON.Vector3(10, 10, 0), scene);
            pointLight1.diffuse = new BABYLON.Color3(0.2, 0.4, 1);
            pointLight1.intensity = 0.6;
            
            const pointLight2 = new BABYLON.PointLight("pointLight2", new BABYLON.Vector3(-10, 5, 10), scene);
            pointLight2.diffuse = new BABYLON.Color3(1, 0.4, 0.2);
            pointLight2.intensity = 0.4;
        }
        
        function createEnhancedMachine() {
            machineGroup = new BABYLON.TransformNode("machineGroup", scene);
            
            // Create different machine types
            switch(currentMachine) {
                case 'robot':
                    createRoboticArm();
                    break;
                case 'cnc':
                    createCNCMachine();
                    break;
                case 'turbine':
                    createWindTurbine();
                    break;
                default:
                    createRoboticArm();
            }
            
            // Add ground
            createEnhancedGround();
        }
        
        function createRoboticArm() {
            // Base
            const base = BABYLON.MeshBuilder.CreateCylinder("base", {height: 1, diameter: 2}, scene);
            base.position.y = 0.5;
            base.parent = machineGroup;
            
            // Enhanced material
            const baseMaterial = new BABYLON.PBRMaterial("baseMaterial", scene);
            baseMaterial.baseColor = new BABYLON.Color3(0.2, 0.3, 0.8);
            baseMaterial.metallicFactor = 0.8;
            baseMaterial.roughnessFactor = 0.2;
            base.material = baseMaterial;
            
            // Arm segments
            for (let i = 0; i < 3; i++) {
                const segment = BABYLON.MeshBuilder.CreateBox("segment" + i, {width: 0.3, height: 1.5, depth: 0.3}, scene);
                segment.position.y = 1.5 + (i * 1.5);
                segment.parent = machineGroup;
                
                const segmentMaterial = new BABYLON.PBRMaterial("segmentMaterial" + i, scene);
                segmentMaterial.baseColor = new BABYLON.Color3(0.6, 0.6, 0.6);
                segmentMaterial.metallicFactor = 0.9;
                segmentMaterial.roughnessFactor = 0.1;
                segment.material = segmentMaterial;
            }
            
            // Add glow effect
            const glowLayer = new BABYLON.GlowLayer("glow", scene);
            glowLayer.customEmissiveColorSelector = function(mesh, subMesh, material, result) {
                if (mesh.name.includes("segment")) {
                    result.set(0.2, 0.4, 1, 0.3);
                } else {
                    result.set(0, 0, 0, 0);
                }
            };
        }
        
        function createWindTurbine() {
            // Tower
            const tower = BABYLON.MeshBuilder.CreateCylinder("tower", {height: 8, diameterTop: 0.8, diameterBottom: 1.2}, scene);
            tower.position.y = 4;
            tower.parent = machineGroup;
            
            const towerMaterial = new BABYLON.PBRMaterial("towerMaterial", scene);
            towerMaterial.baseColor = new BABYLON.Color3(0.9, 0.9, 0.9);
            towerMaterial.metallicFactor = 0.1;
            towerMaterial.roughnessFactor = 0.8;
            tower.material = towerMaterial;
            
            // Nacelle
            const nacelle = BABYLON.MeshBuilder.CreateBox("nacelle", {width: 3, height: 1, depth: 1}, scene);
            nacelle.position.y = 8;
            nacelle.parent = machineGroup;
            nacelle.material = towerMaterial;
            
            // Hub
            const hub = BABYLON.MeshBuilder.CreateSphere("hub", {diameter: 0.8}, scene);
            hub.position = new BABYLON.Vector3(1.5, 8, 0);
            hub.parent = machineGroup;
            
            // Blades
            for (let i = 0; i < 3; i++) {
                const blade = BABYLON.MeshBuilder.CreateBox("blade" + i, {width: 0.1, height: 4, depth: 0.5}, scene);
                blade.position = new BABYLON.Vector3(1.5, 8, 0);
                blade.rotation.z = (i * Math.PI * 2 / 3);
                blade.position.y += 2;
                blade.parent = machineGroup;
                
                const bladeMaterial = new BABYLON.PBRMaterial("bladeMaterial", scene);
                bladeMaterial.baseColor = new BABYLON.Color3(0.8, 0.8, 0.9);
                bladeMaterial.metallicFactor = 0.3;
                bladeMaterial.roughnessFactor = 0.4;
                blade.material = bladeMaterial;
            }
        }
        
        function createEnhancedGround() {
            const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 20, height: 20}, scene);
            
            const groundMaterial = new BABYLON.PBRMaterial("groundMaterial", scene);
            groundMaterial.baseColor = new BABYLON.Color3(0.1, 0.15, 0.2);
            groundMaterial.metallicFactor = 0.1;
            groundMaterial.roughnessFactor = 0.9;
            
            // Add normal map for surface detail
            groundMaterial.bumpTexture = new BABYLON.Texture("/static/textures/normal.jpg", scene);
            ground.material = groundMaterial;
            ground.receiveShadows = true;
        }
        
        function setupPostProcessing() {
            // SSAO
            const ssaoRatio = 0.5;
            const ssaoRenderPipeline = new BABYLON.SSAORenderingPipeline("ssaoPipeline", scene, ssaoRatio);
            scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline("ssaoPipeline", camera);
            
            // Bloom
            const defaultPipeline = new BABYLON.DefaultRenderingPipeline("defaultPipeline", true, scene, [camera]);
            defaultPipeline.bloomEnabled = true;
            defaultPipeline.bloomThreshold = 0.9;
            defaultPipeline.bloomWeight = 0.3;
            defaultPipeline.bloomKernel = 64;
            
            // Tone mapping
            defaultPipeline.toneMappingEnabled = true;
            defaultPipeline.toneMappingType = BABYLON.TonemappingOperator.Photographic;
            
            postProcessPipeline = defaultPipeline;
        }
        
        function setupParticleSystem() {
            // Sparks particle system
            particleSystem = new BABYLON.ParticleSystem("sparks", 2000, scene);
            particleSystem.particleTexture = new BABYLON.Texture("/static/textures/spark.png", scene);
            
            particleSystem.emitter = machineGroup;
            particleSystem.minEmitBox = new BABYLON.Vector3(-1, 0, -1);
            particleSystem.maxEmitBox = new BABYLON.Vector3(1, 0, 1);
            
            particleSystem.color1 = new BABYLON.Color4(1, 0.5, 0, 1.0);
            particleSystem.color2 = new BABYLON.Color4(1, 1, 0, 1.0);
            particleSystem.colorDead = new BABYLON.Color4(0, 0, 0, 0.0);
            
            particleSystem.minSize = 0.1;
            particleSystem.maxSize = 0.5;
            
            particleSystem.minLifeTime = 0.3;
            particleSystem.maxLifeTime = 1.5;
            
            particleSystem.emitRate = 150;
            
            particleSystem.direction1 = new BABYLON.Vector3(-2, 8, 2);
            particleSystem.direction2 = new BABYLON.Vector3(2, 8, -2);
            
            particleSystem.minEmitPower = 1;
            particleSystem.maxEmitPower = 3;
            particleSystem.updateSpeed = 0.005;
            
            particleSystem.start();
        }
        
        function animateMachine() {
            if (machineGroup) {
                const time = performance.now() * 0.001;
                
                if (currentMachine === 'turbine') {
                    // Rotate turbine blades
                    const blades = scene.meshes.filter(mesh => mesh.name.includes("blade"));
                    blades.forEach(blade => {
                        blade.rotation.x += 0.05;
                    });
                } else {
                    // General machine animation
                    machineGroup.rotation.y += 0.01;
                }
                
                // Update sensor-based effects
                updateSensorEffects();
            }
        }
        
        function updateSensorEffects() {
            if (sensorData.temperature > 85) {
                // Add heat distortion effect
                const heatMaterial = scene.getMaterialByName("heatMaterial");
                if (heatMaterial) {
                    heatMaterial.emissiveColor = new BABYLON.Color3(1, 0.3, 0);
                }
            }
            
            if (sensorData.vibration > 0.8) {
                // Add vibration effect
                const vibrationOffset = (Math.random() - 0.5) * 0.1;
                if (machineGroup) {
                    machineGroup.position.x = vibrationOffset;
                    machineGroup.position.z = vibrationOffset;
                }
            }
        }
        
        function updatePerformanceDisplay() {
            document.getElementById('fpsDisplay').textContent = Math.round(engine.getFps());
            document.getElementById('drawCallsDisplay').textContent = scene.getActiveMeshes().length;
            document.getElementById('trianglesDisplay').textContent = scene.getTotalVertices();
        }
        
        // Event listeners and API calls
        document.addEventListener('DOMContentLoaded', function() {
            initBabylonScene();
            setupEventListeners();
            startDataUpdates();
        });
        
        function setupEventListeners() {
            // Machine selection
            document.getElementById('machineSelect').addEventListener('change', function(e) {
                currentMachine = e.target.value;
                switchMachine(currentMachine);
            });
            
            // Graphics controls
            document.getElementById('lightingControl').addEventListener('input', function(e) {
                const intensity = e.target.value / 100;
                scene.lights.forEach(light => {
                    if (light instanceof BABYLON.DirectionalLight) {
                        light.intensity = intensity * 1.2;
                    }
                });
                document.getElementById('lightingValue').textContent = e.target.value + '%';
            });
            
            document.getElementById('fovControl').addEventListener('input', function(e) {
                camera.fov = (e.target.value * Math.PI) / 180;
                document.getElementById('fovValue').textContent = e.target.value + '째';
            });
            
            // Material changes
            document.getElementById('materialSelect').addEventListener('change', function(e) {
                changeMaterial(e.target.value);
            });
            
            // Post-processing
            document.getElementById('postProcessSelect').addEventListener('change', function(e) {
                updatePostProcessing(e.target.value);
            });
            
            // Screenshot
            document.getElementById('captureScreenshot').addEventListener('click', function() {
                BABYLON.ScreenshotTools.CreateScreenshotUsingRenderTarget(engine, camera, 1920);
            });
        }
        
        function switchMachine(machineType) {
            if (machineGroup) {
                machineGroup.dispose();
            }
            currentMachine = machineType;
            createEnhancedMachine();
        }
        
        function changeMaterial(materialType) {
            scene.meshes.forEach(mesh => {
                if (mesh.material && mesh.name !== 'ground') {
                    const material = new BABYLON.PBRMaterial(materialType + "Material", scene);
                    
                    switch(materialType) {
                        case 'metallic':
                            material.baseColor = new BABYLON.Color3(0.7, 0.7, 0.8);
                            material.metallicFactor = 0.9;
                            material.roughnessFactor = 0.1;
                            break;
                        case 'carbon':
                            material.baseColor = new BABYLON.Color3(0.1, 0.1, 0.1);
                            material.metallicFactor = 0.2;
                            material.roughnessFactor = 0.3;
                            break;
                        case 'glass':
                            material.baseColor = new BABYLON.Color3(0.9, 0.9, 1);
                            material.metallicFactor = 0.0;
                            material.roughnessFactor = 0.0;
                            material.alpha = 0.3;
                            break;
                        default:
                            material.baseColor = new BABYLON.Color3(0.5, 0.5, 0.5);
                            material.metallicFactor = 0.5;
                            material.roughnessFactor = 0.5;
                    }
                    
                    mesh.material = material;
                }
            });
        }
        
        function updatePostProcessing(effectType) {
            if (postProcessPipeline) {
                switch(effectType) {
                    case 'bloom':
                        postProcessPipeline.bloomEnabled = true;
                        postProcessPipeline.imageProcessingEnabled = false;
                        break;
                    case 'ssao':
                        postProcessPipeline.bloomEnabled = false;
                        break;
                    case 'all':
                        postProcessPipeline.bloomEnabled = true;
                        postProcessPipeline.imageProcessingEnabled = true;
                        break;
                    default:
                        postProcessPipeline.bloomEnabled = false;
                        postProcessPipeline.imageProcessingEnabled = false;
                }
            }
        }
        
        // Data updates
        function startDataUpdates() {
            updateSensorData();
            setInterval(updateSensorData, 3000);
        }
        
        async function updateSensorData() {
            try {
                const response = await fetch('/api/twin-data');
                const data = await response.json();
                sensorData = data;
                
                updateSensorDisplay(data);
                updateSensorVisualization(data);
                
            } catch (error) {
                console.error('Error updating twin data:', error);
            }
        }
        
        function updateSensorDisplay(data) {
            document.getElementById('twinTemp').textContent = `${data.temperature}째F`;
            document.getElementById('twinPressure').textContent = `${data.pressure} bar`;
            document.getElementById('twinVibration').textContent = `${data.vibration}`;
            document.getElementById('twinRpm').textContent = `${data.rpm} rpm`;
            document.getElementById('twinPower').textContent = `${data.power} kW`;
            
            // Update progress bars
            document.getElementById('tempBar').style.width = `${Math.min(100, (data.temperature / 100) * 100)}%`;
            document.getElementById('pressureBar').style.width = `${Math.min(100, (data.pressure / 3) * 100)}%`;
            document.getElementById('vibrationBar').style.width = `${Math.min(100, (data.vibration / 1.5) * 100)}%`;
            document.getElementById('rpmBar').style.width = `${Math.min(100, (data.rpm / 3000) * 100)}%`;
            document.getElementById('powerBar').style.width = `${Math.min(100, (data.power / 200) * 100)}%`;
            
            // Update status
            const statusElement = document.getElementById('twinStatus');
            statusElement.textContent = data.status;
            statusElement.className = `px-2 py-1 rounded-full text-xs font-semibold status-${data.status.toLowerCase()}`;
        }
        
        function updateSensorVisualization(data) {
            // This function would update 3D visual effects based on sensor data
            updateSensorEffects();
        }
    </script>
</body>
</html>
